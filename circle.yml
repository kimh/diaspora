machine:
  ruby:
    version: 2.3.4
  environment:
    PLATFORM: "1.0"
    RAILS_ENV: test
    S3_BUCKET: "s3://ci-bench2"

dependencies:
  override:
    - gem install bundler
    - bin/bundle install --jobs $(nproc) --no-deployment --without production development --with mysql --path vendor/bundle

database:
  override:
      - mkdir /tmp/benchmark
      - bash -c "time -p bin/rake db:create db:migrate" > /tmp/db_migrate.output 2>&1
      - cat /tmp/db_migrate.output
      - tail -3 /tmp/db_migrate.output | grep real | awk '{printf "%f", $2}' > /tmp/benchmark/db_migrate

      - bash -c "time -p BUILD_TYPE=other ./script/ci/build.sh" > /tmp/rspec.output 2>&1
      - cat /tmp/rspec.output
      - tail -3 /tmp/rspec.output | grep real | awk '{printf "%f", $2}' > /tmp/benchmark/rspec

      - cat /tmp/benchmark/*

      - ./generate-result.sh > /tmp/benchmark/result_$CIRCLE_BUILD_NUM.json

      - aws s3 cp /tmp/benchmark/result_$CIRCLE_BUILD_NUM.json $S3_BUCKET/circleci/$PLATFORM/diaspora/

      # Run ci-bench
      - curl -s https://packagecloud.io/install/repositories/akopytov/sysbench/script.deb.sh | sudo bash
      - sudo apt -y install jq awscli git mysql-workbench sysbench
      - git clone https://github.com/kimh/ci-bench.git
      - cd ci-bench && ./benchmark.sh $PLATFORM $S3_BUCKET

test:
  override:
    - exit 0
